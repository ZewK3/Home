<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VMOSCloud Real-time Multi Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
  <style>
    video {
      width: 100%;
      height: auto;
      background: black;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">VMOS Cloud Real-time Device Viewer</h1>
  <div id="deviceContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"></div>
  <button onclick="addDevice()" class="mt-6 bg-green-600 text-white px-4 py-2 rounded">+ Add Device</button>

  <script>
    let devices = [];

    async function loginAKSK(ak, sk) {
      const res = await fetch('https://api.vmoscloud.com/api/v1/user/akskLogin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accessKey: ak, secretKey: sk })
      });
      return res.json();
    }

    async function getDeviceList(token) {
      const res = await fetch('https://api.vmoscloud.com/api/v1/device/getDeviceList', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: token },
        body: JSON.stringify({})
      });
      return res.json();
    }

    async function getStreamURL(token, deviceId) {
      const res = await fetch('https://api.vmoscloud.com/api/v1/device/getDevicePullStreamAddress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: token },
        body: JSON.stringify({ device: deviceId, type: "WEBRTC" })
      });
      return res.json();
    }

    function createVideoElement(id) {
      const container = document.createElement('div');
      container.className = "bg-white rounded p-4 shadow";

      container.innerHTML = `
        <input id="${id}-ak" class="border p-2 w-full mb-2" placeholder="Access Key ID" />
        <input id="${id}-sk" class="border p-2 w-full mb-2" placeholder="Secret Access Key" />
        <button onclick="connectDevice('${id}')" class="bg-blue-500 text-white px-3 py-2 rounded w-full">Connect</button>
        <select id="${id}-deviceSelect" class="border p-2 w-full my-2"></select>
        <video id="${id}-video" autoplay playsinline controls muted></video>
      `;

      document.getElementById('deviceContainer').appendChild(container);
    }

    function addDevice() {
      const id = `device-${devices.length}`;
      createVideoElement(id);
      devices.push({ id, token: '', pc: null });
    }

    async function connectDevice(id) {
      const ak = document.getElementById(`${id}-ak`).value;
      const sk = document.getElementById(`${id}-sk`).value;
      const loginRes = await loginAKSK(ak, sk);

      if (loginRes.code !== 0) return alert("Login failed");

      const token = loginRes.data.token;
      const deviceList = await getDeviceList(token);
      if (deviceList.code !== 0) return alert("Failed to get devices");

      const select = document.getElementById(`${id}-deviceSelect`);
      select.innerHTML = "";
      deviceList.data.forEach(device => {
        const opt = document.createElement("option");
        opt.value = device.deviceId;
        opt.text = device.deviceName || device.deviceId;
        select.appendChild(opt);
      });

      select.onchange = async () => {
        const deviceId = select.value;
        const streamRes = await getStreamURL(token, deviceId);
        if (streamRes.code !== 0) return alert("Failed to get stream URL");

        const { offer, iceServers } = streamRes.data;
        const pc = new RTCPeerConnection({ iceServers });
        devices.find(d => d.id === id).pc = pc;

        pc.ontrack = (event) => {
          document.getElementById(`${id}-video`).srcObject = event.streams[0];
        };

        await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: offer }));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Send answer to server
        await fetch('https://api.vmoscloud.com/api/v1/device/sendDeviceStreamAnswer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: token },
          body: JSON.stringify({ device: deviceId, answer: answer.sdp })
        });

        // Handle ICE candidates
        pc.onicecandidate = async (e) => {
          if (e.candidate) {
            await fetch('https://api.vmoscloud.com/api/v1/device/sendDeviceIceCandidate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: token },
              body: JSON.stringify({ device: deviceId, candidate: e.candidate })
            });
          }
        };

        // Pull remote ICE candidates
        setInterval(async () => {
          const res = await fetch('https://api.vmoscloud.com/api/v1/device/getDeviceIceCandidateList', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: token },
            body: JSON.stringify({ device: deviceId })
          });
          const json = await res.json();
          if (json.code === 0) {
            json.data.forEach(c => {
              pc.addIceCandidate(new RTCIceCandidate(c));
            });
          }
        }, 3000);
      };

      // Auto-select first device
      select.dispatchEvent(new Event('change'));
    }
  </script>
</body>
</html>
