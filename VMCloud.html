<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VMOSCloud Remote Controller</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto space-y-4">
    <h1 class="text-2xl font-bold mb-4">VMOS Cloud Remote Controller</h1>

    <div class="grid grid-cols-2 gap-4">
      <input id="accessKeyId" class="p-2 border rounded w-full" placeholder="Access Key ID">
      <input id="secretAccessKey" class="p-2 border rounded w-full" placeholder="Secret Access Key">
      <button onclick="login()" class="col-span-2 bg-blue-500 text-white py-2 px-4 rounded">Login</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <select id="deviceId" class="p-2 border rounded w-full"></select>
      <input id="textInput" class="p-2 border rounded w-full" placeholder="Send text" onkeydown="sendTextKey(event)">
    </div>

    <canvas id="touchCanvas" class="w-full h-64 bg-white border"></canvas>

    <div class="grid grid-cols-4 gap-2 mt-4">
      <button onclick="sendKey('KEYCODE_DPAD_UP')" class="bg-gray-200 py-2 rounded">⬆️</button>
      <button onclick="sendKey('KEYCODE_DPAD_LEFT')" class="bg-gray-200 py-2 rounded">⬅️</button>
      <button onclick="sendKey('KEYCODE_DPAD_RIGHT')" class="bg-gray-200 py-2 rounded">➡️</button>
      <button onclick="sendKey('KEYCODE_DPAD_DOWN')" class="bg-gray-200 py-2 rounded">⬇️</button>
      <button onclick="sendKey('KEYCODE_ENTER')" class="bg-green-300 py-2 rounded">Enter</button>
      <button onclick="sendKey('KEYCODE_BACK')" class="bg-red-300 py-2 rounded">Back</button>
    </div>

    <div id="joystick" class="w-40 h-40 mt-6"></div>
  </div>

  <script>
    let token = "";

    async function login() {
      const ak = document.getElementById("accessKeyId").value;
      const sk = document.getElementById("secretAccessKey").value;

      const res = await fetch("https://cloud.vmoscloud.com/api/v1/user/akskLogin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accessKey: ak, secretKey: sk })
      });

      const json = await res.json();
      if (json.code === 0 && json.data.token) {
        token = json.data.token;
        alert("Login successful");
        fetchDevices();
      } else {
        alert("Login failed: " + json.message);
      }
    }

    async function fetchDevices() {
      const res = await fetch("https://cloud.vmoscloud.com/api/v1/device/getDeviceList", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: token },
        body: JSON.stringify({})
      });

      const json = await res.json();
      const select = document.getElementById("deviceId");
      select.innerHTML = "";
      json.data.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.deviceId;
        opt.textContent = d.deviceName || d.deviceId;
        select.appendChild(opt);
      });
    }

    function getDevice() {
      return document.getElementById("deviceId").value;
    }

    function sendKey(code) {
      if (!token) return alert("Not logged in");
      fetch("https://cloud.vmoscloud.com/api/v1/device/sendKeyCode", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: token },
        body: JSON.stringify({ device: getDevice(), keyCode: code })
      });
    }

    function sendTextKey(event) {
      if (event.key.length === 1 && token) {
        fetch("https://cloud.vmoscloud.com/api/v1/device/sendText", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: token },
          body: JSON.stringify({ device: getDevice(), text: event.key })
        });
      }
    }

    function sendTouch(x, y) {
      if (!token) return;
      fetch("https://cloud.vmoscloud.com/api/v1/device/sendTap", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: token },
        body: JSON.stringify({ device: getDevice(), x: Math.round(x), y: Math.round(y) })
      });
    }

    const canvas = document.getElementById("touchCanvas");
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (1080 / canvas.clientWidth);
      const y = (e.clientY - rect.top) * (1920 / canvas.clientHeight);
      sendTouch(x, y);
    });

    const joystick = nipplejs.create({
      zone: document.getElementById('joystick'),
      mode: 'static',
      position: { left: '50%', top: '50%' },
      color: 'blue'
    });

    joystick.on('dir', (evt, data) => {
      if (data.direction) {
        const map = {
          up: 'KEYCODE_DPAD_UP',
          down: 'KEYCODE_DPAD_DOWN',
          left: 'KEYCODE_DPAD_LEFT',
          right: 'KEYCODE_DPAD_RIGHT'
        };
        sendKey(map[data.direction.angle]);
      }
    });
  </script>
</body>
</html>
