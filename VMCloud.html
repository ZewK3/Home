<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VMOS Device Manager</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    #deviceList {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }
    .device {
      background: white;
      border-radius: 8px;
      padding: 0.5rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 360px;
    }
    iframe {
      width: 100%;
      height: 720px;
      border: none;
    }
    input, button {
      margin: 0.25rem 0;
      padding: 0.5rem;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>VMOS Device Manager</h1>
  <div>
    <input type="text" id="deviceName" placeholder="Tên thiết bị" />
    <input type="text" id="deviceUrl" placeholder="URL iframe VMOS" />
    <button onclick="addDevice()">Thêm thiết bị</button>
  </div>
  <div id="deviceList"></div>

  <script>
    const API_BASE = "https://vmcloud.tocotoco.workers.dev";
    let devices = [];

    async function fetchDevices() {
      try {
        const res = await fetch(`${API_BASE}/api/devices`);
        devices = await res.json();
        renderDevices();
      } catch (err) {
        console.error("Failed to load devices:", err);
      }
    }

    async function saveDeviceToCloud(device) {
      await fetch(`${API_BASE}/api/devices`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(device)
      });
    }

    async function deleteDeviceFromCloud(name) {
      await fetch(`${API_BASE}/api/devices?name=${encodeURIComponent(name)}`, {
        method: "DELETE"
      });
    }

    function renderDevices() {
      const container = document.getElementById("deviceList");
      container.innerHTML = "";
      devices.forEach((device) => {
        const wrapper = document.createElement("div");
        wrapper.className = "device";
        wrapper.innerHTML = `
          <strong>${device.name}</strong>
          <iframe src="${device.url}" allow="camera; microphone; fullscreen"></iframe>
          <button onclick="renameDevice('${device.name}')">Đổi tên</button>
          <button onclick="deleteDevice('${device.name}')">Xóa</button>
        `;
        container.appendChild(wrapper);
      });
    }

    async function addDevice() {
      const name = document.getElementById("deviceName").value.trim();
      const url = document.getElementById("deviceUrl").value.trim();
      if (!name || !url) return;
      const newDevice = { name, url };
      devices.push(newDevice);
      renderDevices();
      await saveDeviceToCloud(newDevice);
      document.getElementById("deviceName").value = "";
      document.getElementById("deviceUrl").value = "";
    }

    async function deleteDevice(name) {
      devices = devices.filter((d) => d.name !== name);
      renderDevices();
      await deleteDeviceFromCloud(name);
    }

    async function renameDevice(oldName) {
      const newName = prompt("Nhập tên mới:", oldName);
      if (!newName || newName === oldName) return;
      const device = devices.find((d) => d.name === oldName);
      if (!device) return;
      device.name = newName;
      await deleteDeviceFromCloud(oldName);
      await saveDeviceToCloud(device);
      renderDevices();
    }

    fetchDevices();
  </script>
</body>
</html>
