<script>
  let token = "";

  async function login() {
    const ak = document.getElementById("accessKeyId").value;
    const sk = document.getElementById("secretAccessKey").value;

    const res = await fetch("https://api.vmoscloud.com/api/v1/user/akskLogin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accessKey: ak, secretKey: sk })
    });

    const json = await res.json();
    if (json.code === 0 && json.data.token) {
      token = json.data.token;
      alert("Login successful");
      fetchDevices();
    } else {
      alert("Login failed: " + json.message);
    }
  }

  async function fetchDevices() {
    const res = await fetch("https://api.vmoscloud.com/api/v1/device/getDeviceList", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: token },
      body: JSON.stringify({})
    });

    const json = await res.json();
    const select = document.getElementById("deviceId");
    select.innerHTML = "";
    json.data.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.deviceId;
      opt.textContent = d.deviceName || d.deviceId;
      select.appendChild(opt);
    });
  }

  function getDevice() {
    return document.getElementById("deviceId").value;
  }

  function sendKey(code) {
    if (!token) return alert("Not logged in");
    fetch("https://api.vmoscloud.com/api/v1/device/sendKeyCode", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: token },
      body: JSON.stringify({ device: getDevice(), keyCode: code })
    });
  }

  function sendTextKey(event) {
    if (event.key.length === 1 && token) {
      fetch("https://api.vmoscloud.com/api/v1/device/sendText", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: token },
        body: JSON.stringify({ device: getDevice(), text: event.key })
      });
    }
  }

  function sendTouch(x, y) {
    if (!token) return;
    fetch("https://api.vmoscloud.com/api/v1/device/sendTap", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: token },
      body: JSON.stringify({ device: getDevice(), x: Math.round(x), y: Math.round(y) })
    });
  }

  const canvas = document.getElementById("touchCanvas");
  canvas.addEventListener("click", (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (1080 / canvas.clientWidth);
    const y = (e.clientY - rect.top) * (1920 / canvas.clientHeight);
    sendTouch(x, y);
  });

  const joystick = nipplejs.create({
    zone: document.getElementById('joystick'),
    mode: 'static',
    position: { left: '50%', top: '50%' },
    color: 'blue'
  });

  joystick.on('dir', (evt, data) => {
    if (data.direction) {
      const map = {
        up: 'KEYCODE_DPAD_UP',
        down: 'KEYCODE_DPAD_DOWN',
        left: 'KEYCODE_DPAD_LEFT',
        right: 'KEYCODE_DPAD_RIGHT'
      };
      sendKey(map[data.direction.angle]);
    }
  });
</script>
