<!DOCTYPE html>
<html>
<head>
    <title>API Call Test</title>
</head>
<body>
    <h1>Testing API Call Behavior</h1>
    <div id="test-results"></div>
    
    <script>
        // Mock localStorage with test user data
        const testUserData = {
            employeeId: "TEST001",
            fullName: "Test User",
            position: "AD",
            storeName: "Test Store"
        };
        
        localStorage.setItem('hr_user_data', JSON.stringify(testUserData));
        localStorage.setItem('hr_auth_token', 'test_token_123');
        
        // Track API calls
        let apiCallCount = 0;
        const apiCalls = [];
        
        // Mock fetch to track API calls
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (url && url.includes('getDashboardStats')) {
                apiCallCount++;
                apiCalls.push({
                    timestamp: new Date().toISOString(),
                    url: url,
                    callNumber: apiCallCount
                });
                console.log(`API Call #${apiCallCount}: getDashboardStats at ${new Date().toISOString()}`);
            }
            
            // Return mock data for getDashboardStats
            if (url && url.includes('getDashboardStats')) {
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve({
                        totalEmployees: 25,
                        todaySchedules: 15,
                        pendingRequests: 3,
                        recentMessages: 7,
                        currentDay: 'T2'
                    })
                });
            }
            
            return originalFetch.apply(this, args);
        };
        
        // Display results after 5 seconds
        setTimeout(() => {
            const results = document.getElementById('test-results');
            results.innerHTML = `
                <h2>API Call Test Results</h2>
                <p><strong>Total getDashboardStats calls:</strong> ${apiCallCount}</p>
                <h3>Call Details:</h3>
                <ul>
                    ${apiCalls.map(call => `<li>Call #${call.callNumber} at ${call.timestamp}</li>`).join('')}
                </ul>
                <p><strong>Expected:</strong> Maximum 1 call during initialization</p>
                <p><strong>Status:</strong> ${apiCallCount <= 1 ? '✅ PASS' : '❌ FAIL - Too many calls'}</p>
            `;
        }, 5000);
        
        console.log('Test setup complete. Monitoring API calls...');
    </script>
    
    <!-- Load the actual dashboard scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth-manager.js"></script>
    <script src="../assets/js/dashboard-handler.js"></script>
    <script src="../assets/js/main-init.js"></script>
</body>
</html>