<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order ToCoToCo - L·∫°c Long Qu√¢n</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f8e1e9, #f5c7d2);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      background: linear-gradient(90deg, #ff6f61, #ff8a80);
      color: white;
      text-align: center;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .menu-toggle {
      display: none;
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.3em;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    #auth-control {
      position: absolute;
      right: 10px;
      top: 5px;
      display: flex;
      gap: 10px;
    }
    #auth-control button {
      background: white;
      color: #ff6f61;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    #auth-control button:hover {
      background: #ffe0e0;
    }
    .container {
      display: flex;
      max-width: 1200px;
      width: 100%;
      height: calc(100vh - 36px);
      margin: 10px auto;
      gap: 15px;
      overflow: hidden;
    }
    .sidebar {
      width: 280px;
      background: #fff;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow-y: auto;
      max-height: calc(100vh - 36px);
      transition: transform 0.3s ease;
    }
    .sidebar h3 {
      font-size: 1.4em;
      color: #ff6f61;
      margin: 0 0 15px;
      text-align: center;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      flex-grow: 1;
    }
    .sidebar ul li {
      padding: 12px;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.3s ease;
      font-size: 1.1em;
    }
    .sidebar ul li:hover {
      background: #ff6f61;
      color: white;
      transform: translateX(5px);
    }
    .sidebar ul li.active {
      background: #ff6f61;
      color: white;
    }
    .cart, .history {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    .cart:hover, .history:hover {
      background: #ff6f61;
      color: white;
    }
    .cart span {
      font-weight: bold;
      margin-left: 5px;
    }
    .content {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      overflow-y: auto;
      max-height: 100%;
      padding: 10px;
    }
    .product {
      width: 150px;
      background: #fff;
      border-radius: 15px;
      padding: 5px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 250px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .product:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .product img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 10px;
    }
    .product h3 {
      font-size: 12px;
      margin: 5px 0;
      color: #ff6f61;
    }
    .product p {
      margin: 5px;
      font-size: 12px;
      color: #666;
    }
    .product button {
      background: #ff6f61;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .product button:hover {
      background: #e65b50;
      transform: scale(1.05);
    }
    button {
      /* width: -webkit-fill-available; */
    }
    button#popup-action-btn {
      width: -webkit-fill-available;
    }
    /* Popup Style */
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: #fff;
      padding: 15px;
      border-radius: 15px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: slideIn 0.3s ease;
      width: 350px;
    }
    .popup-content h3 {
      font-size: 20px;
      text-align: center;
      margin: 0 0 10px;
      color: #ff6f61;
    }
    .popup-content p.product-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .option-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .option-row label {
      font-weight: bold;
      width: max-content;
      margin-right: 5px;
      font-size: 14px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      flex: 1;
    }
    .checkbox-group.vertical {
      flex-direction: column;
      gap: 5px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      font-weight: normal;
      margin: 2px;
      font-size: 12px;
    }
    .checkbox-group input[type="checkbox"],
    .checkbox-group input[type="radio"] {
      margin-right: 5px;
    }
    .quantity-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .quantity-group label {
      font-weight: bold;
      width: max-content;
      margin-right: 5px;
      font-size: 14px;
    }
    .quantity-group input {
      width: 50px;
      padding: 5px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .note-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .note-group label {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .note-group textarea {
      width: 100%;
      height: 60px;
      padding: 5px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: none;
    }
    .popup-content button {
      background: #ff6f61;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
    }
    .popup-content button:hover {
      background: #e65b50;
    }
    .popup-content .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      color: #333;
      border: none;
      border-radius: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      font-size: 20px;
      font-weight: normal;
      transition: all 0.3s ease;
    }
    .popup-content .close-btn:hover {
      background: none;
      color: #ff6f61;
    }
    /* Cart Popup */
    .cart-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .cart-content {
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: slideIn 0.3s ease;
    }
    .cart-content h3 {
      margin-top: 0;
      color: #ff6f61;
    }
    .cart-content ul {
      list-style: none;
      padding: 0;
    }
    .cart-content li {
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      font-size: 1.1em;
      position: relative;
    }
    .cart-content .product-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .cart-content .detail-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .cart-content .detail-row label {
      font-weight: bold;
      width: max-content;
      margin-right: 5px;
      font-size: 14px;
    }
    .cart-content .detail-row span {
      font-size: 14px;
      font-weight: normal;
    }
    .cart-content .detail-row.vertical {
      flex-direction: row;
      align-items: flex-start;
      gap: 5px;
    }
    .cart-content .edit-btn, .cart-content .delete-btn {
      position: absolute;
      top: 15px;
      border: none;
      padding: 5px 10px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    .cart-content .edit-btn {
      right: 50px;
      background: #ff6f61;
      color: white;
    }
    .cart-content .edit-btn:hover {
      background: #e65b50;
    }
    .cart-content .delete-btn {
      right: 0;
      background: #ff4444;
      color: white;
    }
    .cart-content .delete-btn:hover {
      background: #cc0000;
    }
    .cart-content .total {
      font-weight: bold;
      margin-top: 20px;
      font-size: 1.2em;
      color: #ff6f61;
    }
    .cart-content .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      color: #333;
      border: none;
      border-radius: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      font-size: 20px;
      font-weight: normal;
      transition: all 0.3s ease;
    }
    .cart-content .close-btn:hover {
      background: none;
      color: #ff6f61;
    }
    .cart-content #checkout-btn {
      margin-top: 15px;
      padding: 12px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .cart-content #checkout-btn:hover {
      background: #218838;
    }
    /* Zoom Popup */
    .zoom-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .zoom-content {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
      animation: slideIn 0.3s ease;
    }
    .zoom-content img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 10px;
    }
    .zoom-content h3 {
      font-size: 1.5em;
      color: #ff6f61;
      margin: 10px 0;
    }
    .zoom-content p {
      font-size: 1.2em;
      color: #666;
      margin: 5px 0;
    }
    .zoom-content .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      color: #333;
      border: none;
      border-radius: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      font-size: 20px;
      font-weight: normal;
      transition: all 0.3s ease;
    }
    .zoom-content .close-btn:hover {
      background: none;
      color: #ff6f61;
    }
    /* Auth Popup */
    #auth-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #auth-popup .auth-box {
      background: white;
      padding: 30px 20px;
      border-radius: 12px;
      width: 320px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      position: relative;
    }
    #auth-popup .auth-box h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5em;
      color: #ff6f61;
    }
    #auth-popup input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    #auth-popup button {
      width: 100%;
      background: #ff6f61;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 20px;
      font-size: 1em;
      cursor: pointer;
    }
    #auth-popup button:hover {
      background: #e95a50;
    }
    /* History Popup */
    .history-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .history-content {
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: slideIn 0.3s ease;
    }
    .history-content h3 {
      margin-top: 0;
      color: #ff6f61;
    }
    .history-content ul {
      list-style: none;
      padding: 0;
    }
    .history-content li {
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      font-size: 1.1em;
    }
    .history-content .order-id {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .history-content .detail-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .history-content .detail-row label {
      font-weight: bold;
      width: max-content;
      margin-right: 5px;
      font-size: 14px;
    }
    .history-content .detail-row span {
      font-size: 14px;
      font-weight: normal;
    }
    .history-content .detail-row.vertical {
      flex-direction: row;
      align-items: flex-start;
      gap: 5px;
    }
    .history-content .total {
      font-weight: bold;
      margin-top: 20px;
      font-size: 1.2em;
      color: #ff6f61;
    }
    .history-content .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      color: #333;
      border: none;
      border-radius: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      font-size: 20px;
      font-weight: normal;
      transition: all 0.3s ease;
    }
    .history-content .close-btn:hover {
      background: none;
      color: #ff6f61;
    }
    /* QR Popup */
    .qr-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .qr-content {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
      animation: slideIn 0.3s ease;
    }
    .qr-content img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 10px;
    }
    .qr-content h3 {
      font-size: 1.5em;
      color: #ff6f61;
      margin: 10px 0;
    }
    .qr-content p {
      font-size: 1.2em;
      color: #666;
      margin: 5px 0;
    }
    .qr-content .countdown {
      font-size: 1.2em;
      color: #ff6f61;
      margin: 10px 0;
    }
    .qr-content button {
      background: #ff6f61;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }
    .qr-content button:hover {
      background: #e65b50;
    }
    .qr-content .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      color: #333;
      border: none;
      border-radius: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      font-size: 20px;
      font-weight: normal;
      transition: all 0.3s ease;
    }
    .qr-content .close-btn:hover {
      background: none;
      color: #ff6f61;
    }
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @media (max-width: 768px) {
      .header {
        padding: 6px;
        font-size: 1em;
      }
      .menu-toggle {
        display: block;
      }
      .container {
        flex-direction: column;
        width: 95%;
        height: auto;
      }
      .sidebar {
        position: fixed;
        top: 0.1vh;
        left: -280px;
        width: 150px;
        height: 99vh;
        max-height: none;
        z-index: 1000;
        border-radius: 0 15px 15px 0;
        padding: 10px;
        background: #fff;
      }
      button.menu-toggle {
        width: auto;
      }
      .sidebar.active {
        left: 0;
      }
      .sidebar h3 {
        font-size: 1.2em;
        margin: 10px 0;
      }
      .sidebar ul li {
        padding: 10px;
        font-size: 1em;
      }
      .cart, .history {
        padding: 10px;
        margin-top: 10px;
      }
      .content {
        max-height: calc(100vh - 36px);
        overflow-y: auto;
        width: 100%;
      }
      .product {
        max-width: 280px;
      }
      .option-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .option-row label {
        width: auto;
        margin-bottom: 5px;
      }
      .cart-content .detail-row {
        flex-direction: row;
        align-items: center;
      }
      .cart-content .detail-row label {
        width: auto;
        margin-right: 5px;
      }
      .cart-content .edit-btn, .cart-content .delete-btn {
        top: 5px;
      }
      .cart-content .edit-btn {
        right: 50px;
      }
      .cart-content .delete-btn {
        right: 5px;
      }
      .zoom-content {
        width: 95%;
      }
      .zoom-content img {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <h1>Tr√† S·ªØa Ngon</h1>
    <div id="auth-control">
      <button onclick="showLoginPopup(false)" id="login-button">ƒêƒÉng nh·∫≠p</button>
      <button onclick="showLoginPopup(true)" id="register-button">ƒêƒÉng k√Ω</button>
      <button onclick="logout()" id="logout-button" style="display: none;">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>
  <div class="container">
    <div class="sidebar" id="sidebar">
      <div>
        <h3>Danh M·ª•c</h3>
        <ul id="category-list"></ul>
      </div>
      <div class="cart" onclick="viewCart()">
        Gi·ªè h√†ng (<span id="cart-count">0</span>)
      </div>
      <div class="history" onclick="viewOrderHistory()">
        L·ªãch s·ª≠ ƒë∆°n h√†ng
      </div>
    </div>
    <div class="content" id="product-list"></div>
  </div>

  <!-- Popup ch·ªçn size, topping, ƒë∆∞·ªùng, ƒë√° -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <button class="close-btn" onclick="closePopup()">√ó</button>
      <h3 id="popup-title">Ch·ªçn t√πy ch·ªçn</h3>
      <p class="product-name" id="popup-product-name"></p>
      
      <div class="option-row">
        <label>Size:</label>
        <div id="size-options" class="checkbox-group"></div>
      </div>
      <div class="option-row">
        <label>Topping:</label>
        <div id="topping-options" class="checkbox-group vertical"></div>
      </div>
      <div class="option-row">
        <label>M·ª©c ƒë∆∞·ªùng:</label>
        <div id="sugar-options" class="checkbox-group"></div>
      </div>
      <div class="option-row">
        <label>M·ª©c ƒë√°:</label>
        <div id="ice-options" class="checkbox-group"></div>
      </div>
      <div class="quantity-group">
        <label>S·ªë l∆∞·ª£ng:</label>
        <input type="number" id="quantity-input" min="1" value="1">
      </div>
      <div class="note-group">
        <label>Ghi ch√∫:</label>
        <textarea id="note-input" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
      </div>
      
      <button id="popup-action-btn" onclick="addToCart()">Th√™m v√†o gi·ªè</button>
    </div>
  </div>

  <!-- Popup gi·ªè h√†ng -->
  <div class="cart-popup" id="cart-popup">
    <div class="cart-content">
      <button class="close-btn" onclick="closeCart()">√ó</button>
      <h3>Gi·ªè h√†ng</h3>
      <ul id="cart-items"></ul>
      <div class="total" id="cart-total">T·ªïng c·ªông: 0 VNƒê</div>
      <button id="checkout-btn" onclick="placeOrder()">ƒê·∫∑t h√†ng</button>
    </div>
  </div>

  <!-- Popup ph√≥ng to s·∫£n ph·∫©m -->
  <div class="zoom-popup" id="zoom-popup">
    <div class="zoom-content">
      <button class="close-btn" onclick="closeZoomPopup()">√ó</button>
      <img id="zoom-image" src="" alt="Product Image">
      <h3 id="zoom-product-name"></h3>
      <p id="zoom-product-price"></p>
    </div>
  </div>

  <!-- Popup ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω -->
  <div id="auth-popup" onclick="hidePopup(event)">
    <div class="auth-box" onclick="event.stopPropagation()">
      <h3 id="auth-title">ƒêƒÉng nh·∫≠p</h3>
      <input id="user-name" placeholder="T√™n c·ªßa b·∫°n" style="display:none;">
      <input id="user-email" placeholder="Email/SƒêT">
      <input id="user-password" type="password" placeholder="M·∫≠t kh·∫©u">
      <button onclick="submitAuth()">Ti·∫øp t·ª•c</button>
    </div>
  </div>

  <!-- Popup l·ªãch s·ª≠ ƒë∆°n h√†ng -->
  <div class="history-popup" id="history-popup">
    <div class="history-content">
      <button class="close-btn" onclick="closeHistoryPopup()">√ó</button>
      <h3>L·ªãch s·ª≠ ƒë∆°n h√†ng</h3>
      <ul id="history-items"></ul>
    </div>
  </div>

  <!-- Popup QR thanh to√°n -->
  <div class="qr-popup" id="qr-popup">
    <div class="qr-content">
      <button class="close-btn" onclick="cancelTransaction()">√ó</button>
      <h3>Thanh to√°n ƒë∆°n h√†ng</h3>
      <img id="popup-qr-image" src="" alt="QR Code">
      <p id="qr-amount"></p>
      <p class="countdown" id="countdown"></p>
      <button id="pause-transaction">Treo giao d·ªãch</button>
      <button id="cancel-transaction" onclick="cancelTransaction()">H·ªßy giao d·ªãch</button>
    </div>
  </div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxseIrDGsm0EN5t6GWCi8-lHO-WJccNl3pR5s2DzSrLRxf5nYje9xUdLlOT0ZkGxlmw0tMZZNKFa8a/pub?output=csv';
    const apiBase = "https://zewk.tocotoco.workers.dev/"; // Thay b·∫±ng URL Cloudflare Worker th·ª±c t·∫ø
    let allData = [];
    let toppings = [];
    let currentProduct = {};
    let cart = [];
    let editingGroupKey = null;
    let isRegisterMode = false;

    // Transaction Tracker for QR Payment
    const transactionTracker = {
      state: {
        baseQRUrl: 'https://api.vietqr.io/image/970403-062611062003-sIxhggL.jpg?accountName=LE%20DAI%20LOI',
        activeTransactions: new Map()
      },
      elements: {
        qrPopup: document.getElementById("qr-popup"),
        popupQrImage: document.getElementById("popup-qr-image"),
        qrAmount: document.getElementById("qr-amount"),
        countdown: document.getElementById("countdown"),
        pauseBtn: document.getElementById("pause-transaction"),
        cancelBtn: document.getElementById("cancel-transaction")
      },
      formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(amount).replace("‚Ç´", " VNƒê");
      },
      formatDateTime() {
        const date = new Date();
        return date.toISOString().replace(/[-:T.]/g, '').slice(0, 14);
      },
      formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
      },
      generateQRCode(amount, transactionId) {
        return `${this.state.baseQRUrl}&amount=${amount}&addInfo=ID${transactionId}`;
      },
      async checkTransactionStatus(transactionId) {
        try {
          const response = await fetch(`${apiBase}?action=checkTransaction&transactionId=ID${transactionId}`);
          if (!response.ok) return false;
          const data = await response.json();
          return data.success === true ? data : false;
        } catch (error) {
          console.error("Error checking transaction:", error);
          return false;
        }
      },
      startTransaction(amount, transactionId, orderId) {
        const transaction = {
          amount: Number(amount),
          timeLeft: 300,
          countdownTimer: null,
          checkInterval: null,
          orderId: orderId
        };

        this.elements.qrAmount.textContent = `S·ªë ti·ªÅn: ${this.formatCurrency(amount)}`;
        this.elements.countdown.textContent = this.formatTime(transaction.timeLeft);

        transaction.countdownTimer = setInterval(() => {
          transaction.timeLeft--;
          if (transaction.timeLeft >= 0) {
            this.elements.countdown.textContent = this.formatTime(transaction.timeLeft);
          }
          if (transaction.timeLeft <= 0) {
            this.handleTransactionTimeout(transactionId);
          }
        }, 1000);

        transaction.checkInterval = setInterval(async () => {
          const serverData = await this.checkTransactionStatus(transactionId);
          if (serverData && this.state.activeTransactions.has(transactionId)) {
            const clientAmount = transaction.amount;
            const serverAmount = Number(serverData.amount);
            if (clientAmount === serverAmount) {
              this.handleTransactionSuccess(transactionId, orderId);
            } else {
              alert(`S·ªë ti·ªÅn kh√¥ng kh·ªõp: Client ${this.formatCurrency(clientAmount)} != Server ${this.formatCurrency(serverAmount)}`);
              this.handleTransactionTimeout(transactionId);
            }
          }
        }, 5000);

        this.state.activeTransactions.set(transactionId, transaction);
      },
      async handleTransactionSuccess(transactionId, orderId) {
        const transaction = this.state.activeTransactions.get(transactionId);
        if (!transaction) return;

        try {
          const response = await fetch(`${apiBase}?action=updateOrderStatus&orderId=${orderId}&status=paid`);
          const data = await response.json();
          if (data.success) {
            alert("Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.");
          } else {
            alert("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng!");
          }
        } catch (error) {
          console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng:", error);
          alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng!");
        }

        clearInterval(transaction.countdownTimer);
        clearInterval(transaction.checkInterval);
        this.state.activeTransactions.delete(transactionId);
        this.resetPopup();
      },
      handleTransactionTimeout(transactionId) {
        const transaction = this.state.activeTransactions.get(transactionId);
        if (!transaction) return;

        clearInterval(transaction.countdownTimer);
        clearInterval(transaction.checkInterval);
        this.state.activeTransactions.delete(transactionId);
        this.resetPopup();
        alert("Giao d·ªãch h·∫øt h·∫°n!");
      },
      resetPopup() {
        this.elements.qrPopup.style.display = "none";
      }
    };

    // H√†m x·ª≠ l√Ω CSV
    function csvToJson(csv) {
      const lines = csv.split('\n').filter(line => line.trim());
      const headers = lines[0].split(',').map(h => h.trim());
      const result = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
        if (values.length < headers.length) continue;
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = values[index] || '';
        });
        if (obj['T√™n m√≥n']) result.push(obj);
      }
      return result;
    }

    // H√†m preload h√¨nh ·∫£nh
    function preloadImages(imageUrls) {
      const uniqueUrls = [...new Set(imageUrls.filter(url => url && url !== 'https://via.placeholder.com/180'))];
      uniqueUrls.forEach(url => {
        const img = new Image();
        img.src = url;
      });
    }

    // L·∫•y d·ªØ li·ªáu t·ª´ Google Sheets v√† preload h√¨nh ·∫£nh
    fetch(csvUrl)
      .then(response => {
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets');
        return response.text();
      })
      .then(csv => {
        allData = csvToJson(csv);
        toppings = allData.filter(item => item['Danh m·ª•c'] === 'Topping').map(item => ({
          name: item['T√™n m√≥n'],
          price: Number(item['Gi√° ti·ªÅn']) || 0
        }));

        const imageUrls = allData.map(item => item['URL h√¨nh ·∫£nh'] || 'https://via.placeholder.com/180');
        preloadImages(imageUrls);

        const categoryList = document.getElementById('category-list');
        const categories = [...new Set(allData.map(item => item['Danh m·ª•c']))].filter(cat => cat !== 'Topping');
        categories.forEach(category => {
          const li = document.createElement('li');
          li.textContent = category;
          li.onclick = () => {
            filterProducts(category);
            if (window.innerWidth <= 768) toggleMenu();
          };
          categoryList.appendChild(li);
        });
        filterProducts(categories[0] || 'Tr√† S·ªØa');
        categoryList.children[0].classList.add('active');
      })
      .catch(error => {
        console.error('L·ªói:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i menu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c Google Sheets.');
      });

    // L·ªçc v√† hi·ªÉn th·ªã s·∫£n ph·∫©m
    function filterProducts(category) {
      const productList = document.getElementById('product-list');
      productList.innerHTML = '';
      const filteredData = allData.filter(item => item['Danh m·ª•c'] === category);
      filteredData.forEach(item => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        productDiv.innerHTML = `
          <img src="${item['URL h√¨nh ·∫£nh'] || 'https://via.placeholder.com/180'}" alt="${item['T√™n m√≥n']}">
          <h3>${item['T√™n m√≥n']}</h3>
          <p>${Number(item['Gi√° ti·ªÅn']).toLocaleString('vi-VN')} VNƒê</p>
          <button onclick="openPopup('${item['T√™n m√≥n']}', '${item['Size'] || 'M,L'}', ${item['Gi√° ti·ªÅn']}, '${item['ƒê∆∞·ªùng'] || '30%,50%,70%,100%'}', '${item['ƒê√°'] || 'Kh√¥ng ƒë√°,√çt ƒë√°,Th∆∞·ªùng,Nhi·ªÅu ƒë√°'}')">Th√™m</button>
        `;
        productDiv.onclick = (e) => {
          if (e.target.tagName !== 'BUTTON') {
            openZoomPopup(item['URL h√¨nh ·∫£nh'] || 'https://via.placeholder.com/180', item['T√™n m√≥n'], Number(item['Gi√° ti·ªÅn']));
          }
        };
        productList.appendChild(productDiv);
      });

      const categoryItems = document.querySelectorAll('#category-list li');
      categoryItems.forEach(item => item.classList.remove('active'));
      const selectedCategory = Array.from(categoryItems).find(item => item.textContent === category);
      if (selectedCategory) selectedCategory.classList.add('active');
    }

    // M·ªü popup ph√≥ng to
    function openZoomPopup(imageUrl, name, price) {
      document.getElementById('zoom-image').src = imageUrl;
      document.getElementById('zoom-product-name').textContent = name;
      document.getElementById('zoom-product-price').textContent = `${price.toLocaleString('vi-VN')} VNƒê`;
      document.getElementById('zoom-popup').style.display = 'flex';
    }

    // ƒê√≥ng popup ph√≥ng to
    function closeZoomPopup() {
      document.getElementById('zoom-popup').style.display = 'none';
    }

    // M·ªü popup ch·ªçn size, topping, ƒë∆∞·ªùng, ƒë√°
    function openPopup(name, sizeOptions, price, sugarOptions = '30%,50%,70%,100%', iceOptions = 'Kh√¥ng ƒë√°,√çt ƒë√°,Th∆∞·ªùng,Nhi·ªÅu ƒë√°', groupKey = null, existingItem = null) {
      editingGroupKey = groupKey;
      currentProduct = existingItem ? { ...existingItem, price: Number(price), toppingPrice: 0 } : { name, size: '', toppings: [], sugar: '', ice: '', price: Number(price), toppingPrice: 0, quantity: 1, note: '' };
      
      document.getElementById('popup-product-name').textContent = name;
      document.getElementById('popup-title').textContent = existingItem ? 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m' : 'Ch·ªçn t√πy ch·ªçn';
      const actionBtn = document.getElementById('popup-action-btn');
      actionBtn.textContent = existingItem ? 'C·∫≠p nh·∫≠t' : 'Th√™m v√†o gi·ªè';
      actionBtn.onclick = existingItem ? updateCartItem : addToCart;

      const sizeContainer = document.getElementById('size-options');
      sizeContainer.innerHTML = '';
      sizeOptions.split(',').forEach(size => {
        if (size.trim()) {
          const sizeTrimmed = size.trim();
          const label = document.createElement('label');
          label.innerHTML = `
            <input type="radio" name="size" value="${sizeTrimmed}" ${existingItem && existingItem.size === sizeTrimmed ? 'checked' : ''}> ${sizeTrimmed}
          `;
          sizeContainer.appendChild(label);
        }
      });

      const toppingContainer = document.getElementById('topping-options');
      toppingContainer.innerHTML = '';
      toppings.forEach(topping => {
        const label = document.createElement('label');
        const isChecked = existingItem && existingItem.toppings.some(t => t.name === topping.name);
        label.innerHTML = `
          <input type="checkbox" name="topping" value="${topping.name}" data-price="${topping.price}" ${isChecked ? 'checked' : ''}> 
          ${topping.name} (+${topping.price.toLocaleString('vi-VN')} VNƒê)
        `;
        toppingContainer.appendChild(label);
      });

      const sugarContainer = document.getElementById('sugar-options');
      sugarContainer.innerHTML = '';
      sugarOptions.split(',').forEach(sugar => {
        if (sugar.trim()) {
          const sugarTrimmed = sugar.trim();
          const label = document.createElement('label');
          label.innerHTML = `
            <input type="radio" name="sugar" value="${sugarTrimmed}" ${existingItem && existingItem.sugar === sugarTrimmed ? 'checked' : ''}> ${sugarTrimmed}
          `;
          sugarContainer.appendChild(label);
        }
      });

      const iceContainer = document.getElementById('ice-options');
      iceContainer.innerHTML = '';
      iceOptions.split(',').forEach(ice => {
        if (ice.trim()) {
          const iceTrimmed = ice.trim();
          const label = document.createElement('label');
          label.innerHTML = `
            <input type="radio" name="ice" value="${iceTrimmed}" ${existingItem && existingItem.ice === iceTrimmed ? 'checked' : ''}> ${iceTrimmed}
          `;
          iceContainer.appendChild(label);
        }
      });

      document.getElementById('quantity-input').value = existingItem ? existingItem.quantity : 1;
      document.getElementById('note-input').value = existingItem ? existingItem.note : '';

      if (groupKey) {
        closeCart();
      }

      document.getElementById('popup').style.display = 'flex';
    }

    function closePopup() {
      document.getElementById('popup').style.display = 'none';
      editingGroupKey = null;
    }

    function addToCart() {
      const size = document.querySelector('input[name="size"]:checked');
      const selectedToppings = document.querySelectorAll('input[name="topping"]:checked');
      const sugar = document.querySelector('input[name="sugar"]:checked');
      const ice = document.querySelector('input[name="ice"]:checked');
      const quantity = document.getElementById('quantity-input').value;
      const note = document.getElementById('note-input').value;

      if (!size) {
        alert('Vui l√≤ng ch·ªçn size!');
        return;
      }
      if (!sugar) {
        alert('Vui l√≤ng ch·ªçn m·ª©c ƒë∆∞·ªùng!');
        return;
      }
      if (!ice) {
        alert('Vui l√≤ng ch·ªçn m·ª©c ƒë√°!');
        return;
      }
      if (quantity < 1) {
        alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!');
        return;
      }

      currentProduct.size = size.value;
      currentProduct.toppings = Array.from(selectedToppings).map(topping => ({
        name: topping.value,
        price: Number(topping.dataset.price)
      }));
      currentProduct.sugar = sugar.value;
      currentProduct.ice = ice.value;
      currentProduct.quantity = Number(quantity);
      currentProduct.note = note;
      currentProduct.toppingPrice = currentProduct.toppings.reduce((sum, t) => sum + t.price, 0);

      if (currentProduct.size === 'L') {
        currentProduct.price += 5000;
      }

      cart.push({ ...currentProduct });
      updateCartCount();
      closePopup();
    }

    function updateCartCount() {
      document.getElementById('cart-count').textContent = cart.length;
    }

    function groupCartItems() {
      const groupedCart = {};
      cart.forEach((item, index) => {
        const key = `${item.name}-${item.size}-${item.sugar}-${item.ice}-${JSON.stringify(item.toppings)}-${item.note}`;
        if (!groupedCart[key]) {
          groupedCart[key] = {
            name: item.name,
            items: [],
            totalPrice: 0,
            totalQuantity: 0,
            key: key
          };
        }
        groupedCart[key].items.push({ ...item, originalIndex: index });
        groupedCart[key].totalPrice += (item.price + item.toppingPrice);
        groupedCart[key].totalQuantity += item.quantity;
      });
      return Object.values(groupedCart);
    }

    function viewCart() {
      const cartPopup = document.getElementById('cart-popup');
      const cartItems = document.getElementById('cart-items');
      cartItems.innerHTML = '';

      if (cart.length === 0) {
        cartItems.innerHTML = '<li>Gi·ªè h√†ng tr·ªëng</li>';
      } else {
        const groupedCart = groupCartItems();
        groupedCart.forEach((group, index) => {
          const li = document.createElement('li');
          const productName = document.createElement('div');
          productName.className = 'product-name';
          productName.textContent = `${index + 1}. ${group.name}`;
          li.appendChild(productName);

          const editBtn = document.createElement('button');
          editBtn.className = 'edit-btn';
          editBtn.textContent = 'Ch·ªânh s·ª≠a';
          editBtn.onclick = () => {
            const item = group.items[0];
            const productData = allData.find(data => data['T√™n m√≥n'] === group.name);
            if (productData) {
              openPopup(
                group.name,
                productData['Size'] || 'M,L',
                productData['Gi√° ti·ªÅn'],
                productData['ƒê∆∞·ªùng'] || '30%,50%,70%,100%',
                productData['ƒê√°'] || 'Kh√¥ng ƒë√°,√çt ƒë√°,Th∆∞·ªùng,Nhi·ªÅu ƒë√°',
                group.key,
                item
              );
            }
          };
          li.appendChild(editBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'X√≥a';
          deleteBtn.onclick = () => {
            cart = cart.filter(item => {
              const key = `${item.name}-${item.size}-${item.sugar}-${item.ice}-${JSON.stringify(item.toppings)}-${item.note}`;
              return key !== group.key;
            });
            updateCartCount();
            viewCart();
          };
          li.appendChild(deleteBtn);

          group.items.forEach(item => {
            const toppingNames = item.toppings.map(t => t.name).join(', ');

            const sizeRow = document.createElement('div');
            sizeRow.className = 'detail-row';
            sizeRow.innerHTML = `<label>Size:</label><span>${item.size}</span>`;
            li.appendChild(sizeRow);

            const toppingRow = document.createElement('div');
            toppingRow.className = 'detail-row vertical';
            toppingRow.innerHTML = `<label>Topping:</label><span>${toppingNames}</span>`;
            li.appendChild(toppingRow);

            const sugarRow = document.createElement('div');
            sugarRow.className = 'detail-row';
            sugarRow.innerHTML = `<label>M·ª©c ƒë∆∞·ªùng:</label><span>${item.sugar}</span>`;
            li.appendChild(sugarRow);

            const iceRow = document.createElement('div');
            iceRow.className = 'detail-row';
            iceRow.innerHTML = `<label>M·ª©c ƒë√°:</label><span>${item.ice}</span>`;
            li.appendChild(iceRow);

            const quantityRow = document.createElement('div');
            quantityRow.className = 'detail-row';
            quantityRow.innerHTML = `<label>S·ªë l∆∞·ª£ng:</label><span>${item.quantity}</span>`;
            li.appendChild(quantityRow);

            const noteRow = document.createElement('div');
            noteRow.className = 'detail-row vertical';
            noteRow.innerHTML = `<label>Ghi ch√∫:</label><span>${item.note || 'Kh√¥ng c√≥'}</span>`;
            li.appendChild(noteRow);

            const priceRow = document.createElement('div');
            priceRow.className = 'detail-row';
            priceRow.innerHTML = `<label>Gi√° ti·ªÅn:</label><span>${group.totalPrice.toLocaleString('vi-VN')} VNƒê</span>`;
            li.appendChild(priceRow);
          });

          cartItems.appendChild(li);
        });
      }

      const total = cart.reduce((sum, item) => sum + (item.price + item.toppingPrice) * item.quantity, 0);
      document.getElementById('cart-total').textContent = `T·ªïng c·ªông: ${total.toLocaleString('vi-VN')} VNƒê`;
      cartPopup.style.display = 'flex';

      if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('active');
      }
    }

    function updateCartItem() {
      const size = document.querySelector('input[name="size"]:checked');
      const selectedToppings = document.querySelectorAll('input[name="topping"]:checked');
      const sugar = document.querySelector('input[name="sugar"]:checked');
      const ice = document.querySelector('input[name="ice"]:checked');
      const quantity = document.getElementById('quantity-input').value;
      const note = document.getElementById('note-input').value;

      if (!size) {
        alert('Vui l√≤ng ch·ªçn size!');
        return;
      }
      if (!sugar) {
        alert('Vui l√≤ng ch·ªçn m·ª©c ƒë∆∞·ªùng!');
        return;
      }
      if (!ice) {
        alert('Vui l√≤ng ch·ªçn m·ª©c ƒë√°!');
        return;
      }
      if (quantity < 1) {
        alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!');
        return;
      }

      cart = cart.filter(item => {
        const key = `${item.name}-${item.size}-${item.sugar}-${item.ice}-${JSON.stringify(item.toppings)}-${item.note}`;
        return key !== editingGroupKey;
      });

      currentProduct.size = size.value;
      currentProduct.toppings = Array.from(selectedToppings).map(topping => ({
        name: topping.value,
        price: Number(topping.dataset.price)
      }));
      currentProduct.sugar = sugar.value;
      currentProduct.ice = ice.value;
      currentProduct.quantity = Number(quantity);
      currentProduct.note = note;
      currentProduct.toppingPrice = currentProduct.toppings.reduce((sum, t) => sum + t.price, 0);

      let basePrice = currentProduct.price;
      if (currentProduct.size === 'L') {
        basePrice += 5000;
      }
      currentProduct.price = basePrice;

      cart.push({ ...currentProduct });
      updateCartCount();
      closePopup();
      viewCart();
    }

    function closeCart() {
      document.getElementById('cart-popup').style.display = 'none';
    }

    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    async function placeOrder() {
      if (cart.length === 0) {
        alert("Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi ƒë·∫∑t h√†ng!");
        return;
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒë·∫∑t h√†ng!");
        showLoginPopup(false);
        return;
      }

      let orderSummary = "üßæ ƒê∆°n h√†ng c·ªßa b·∫°n:\n\n";
      let total = 0;

      cart.forEach((item, index) => {
        const toppingText = item.toppings.map(t => t.name).join(', ') || 'Kh√¥ng';
        const price = (item.price + item.toppingPrice) * item.quantity;
        total += price;

        orderSummary += `${index + 1}. ${item.name} - Size ${item.size}\n`;
        orderSummary += `   ƒê∆∞·ªùng: ${item.sugar}, ƒê√°: ${item.ice}, SL: ${item.quantity}\n`;
        orderSummary += `   Topping: ${toppingText}, Ghi ch√∫: ${item.note || 'Kh√¥ng'}\n`;
        orderSummary += `   Th√†nh ti·ªÅn: ${price.toLocaleString('vi-VN')} VNƒê\n\n`;
      });

      orderSummary += `T·ªïng c·ªông: ${total.toLocaleString('vi-VN')} VNƒê`;

      if (confirm(orderSummary + "\n\nB·∫°n c√≥ mu·ªën x√°c nh·∫≠n ƒë·∫∑t h√†ng kh√¥ng?")) {
        try {
          const response = await fetch(`${apiBase}?action=saveOrder&token=${token}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cart })
          });
          const data = await response.json();

          if (data.message === "ƒê·∫∑t h√†ng th√†nh c√¥ng!") {
            alert(`üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.orderId}\nƒêi·ªÉm t√≠ch l≈©y: +${data.gainedExp}\nT·ªïng ƒëi·ªÉm: ${data.newExp}\nH·∫°ng: ${data.newRank}`);
            
            // T·∫°o m√£ QR thanh to√°n
            const transactionId = transactionTracker.formatDateTime();
            const qrUrl = transactionTracker.generateQRCode(total, transactionId);
            transactionTracker.elements.popupQrImage.src = qrUrl;
            transactionTracker.elements.qrPopup.style.display = 'flex';
            transactionTracker.startTransaction(total, transactionId, data.orderId);

            cart = [];
            updateCartCount();
            closeCart();
          } else {
            alert(data.message || "L·ªói khi ƒë·∫∑t h√†ng!");
          }
        } catch (error) {
          console.error("L·ªói khi ƒë·∫∑t h√†ng:", error);
          alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i!");
        }
      }
    }

    function cancelTransaction() {
      const transactionId = transactionTracker.elements.popupQrImage.src.match(/ID(\d+)/)?.[1];
      if (transactionId && transactionTracker.state.activeTransactions.has(transactionId)) {
        transactionTracker.handleTransactionTimeout(transactionId);
      }
    }

    async function viewOrderHistory() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠ ƒë∆°n h√†ng!");
        showLoginPopup(false);
        return;
      }

      try {
        const response = await fetch(`${apiBase}?action=getOrders&token=${token}`);
        const data = await response.json();

        const historyPopup = document.getElementById('history-popup');
        const historyItems = document.getElementById('history-items');
        historyItems.innerHTML = '';

        if (!data.orders || data.orders.length === 0) {
          historyItems.innerHTML = '<li>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o!</li>';
        } else {
          data.orders.forEach((order, index) => {
            const li = document.createElement('li');
            const orderId = document.createElement('div');
            orderId.className = 'order-id';
            orderId.textContent = `${index + 1}. M√£ ƒë∆°n: ${order.orderId} - Tr·∫°ng th√°i: ${order.status}`;
            li.appendChild(orderId);

            order.cart.forEach(item => {
              const toppingNames = item.toppings.map(t => t.name).join(', ');

              const nameRow = document.createElement('div');
              nameRow.className = 'detail-row';
              nameRow.innerHTML = `<label>T√™n m√≥n:</label><span>${item.name}</span>`;
              li.appendChild(nameRow);

              const sizeRow = document.createElement('div');
              sizeRow.className = 'detail-row';
              sizeRow.innerHTML = `<label>Size:</label><span>${item.size}</span>`;
              li.appendChild(sizeRow);

              const toppingRow = document.createElement('div');
              toppingRow.className = 'detail-row vertical';
              toppingRow.innerHTML = `<label>Topping:</label><span>${toppingNames}</span>`;
              li.appendChild(toppingRow);

              const sugarRow = document.createElement('div');
              sugarRow.className = 'detail-row';
              sugarRow.innerHTML = `<label>M·ª©c ƒë∆∞·ªùng:</label><span>${item.sugar}</span>`;
              li.appendChild(sugarRow);

              const iceRow = document.createElement('div');
              iceRow.className = 'detail-row';
              iceRow.innerHTML = `<label>M·ª©c ƒë√°:</label><span>${item.ice}</span>`;
              li.appendChild(iceRow);

              const quantityRow = document.createElement('div');
              quantityRow.className = 'detail-row';
              quantityRow.innerHTML = `<label>S·ªë l∆∞·ª£ng:</label><span>${item.quantity}</span>`;
              li.appendChild(quantityRow);

              const noteRow = document.createElement('div');
              noteRow.className = 'detail-row vertical';
              noteRow.innerHTML = `<label>Ghi ch√∫:</label><span>${item.note || 'Kh√¥ng c√≥'}</span>`;
              li.appendChild(noteRow);

              const priceRow = document.createElement('div');
              priceRow.className = 'detail-row';
              priceRow.innerHTML = `<label>Gi√° ti·ªÅn:</label><span>${((item.price + item.toppingPrice) * item.quantity).toLocaleString('vi-VN')} VNƒê</span>`;
              li.appendChild(priceRow);
            });

            const totalRow = document.createElement('div');
            totalRow.className = 'detail-row';
            totalRow.innerHTML = `<label>T·ªïng c·ªông:</label><span>${order.total.toLocaleString('vi-VN')} VNƒê</span>`;
            li.appendChild(totalRow);

            historyItems.appendChild(li);
          });
        }

        historyPopup.style.display = 'flex';

        if (window.innerWidth <= 768) {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.remove('active');
        }
      } catch (error) {
        console.error("L·ªói khi t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng:", error);
        alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng!");
      }
    }

    function closeHistoryPopup() {
      document.getElementById('history-popup').style.display = 'none';
    }

    // Auth Functions
    function showLoginPopup(register = false) {
      isRegisterMode = register;
      document.getElementById("auth-title").textContent = register ? "ƒêƒÉng k√Ω" : "ƒêƒÉng nh·∫≠p";
      document.getElementById("user-name").style.display = register ? "block" : "none";
      document.getElementById("auth-popup").style.display = "flex";
    }

    function hidePopup(event) {
      if (event.target.id === "auth-popup") {
        document.getElementById("auth-popup").style.display = "none";
      }
    }

    async function submitAuth() {
      const name = document.getElementById("user-name").value.trim();
      const email = document.getElementById("user-email").value.trim();
      const password = document.getElementById("user-password").value.trim();
      if (!email || !password || (isRegisterMode && !name)) {
        return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
      }

      // M√£ h√≥a m·∫≠t kh·∫©u b·∫±ng SHA-256
      const hashedPassword = CryptoJS.SHA256(password).toString();

      const action = isRegisterMode ? "registerUser" : "loginUser";
      const body = isRegisterMode ? { name, email, password: hashedPassword } : { email, password: hashedPassword };

      try {
        const response = await fetch(`${apiBase}?action=${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await response.json();

        if (data.token) {
          localStorage.setItem("token", data.token);
          document.getElementById("auth-popup").style.display = "none";
          updateUserInfo(data.name || name);
        } else {
          alert(data.message || "L·ªói khi ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω.");
        }
      } catch (error) {
        console.error("L·ªói:", error);
        alert("ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!");
      }
    }

    function updateUserInfo(name) {
      document.querySelector(".header h1").textContent = `üëã Xin ch√†o, ${name}`;
      document.getElementById("login-button").style.display = "none";
      document.getElementById("register-button").style.display = "none";
      document.getElementById("logout-button").style.display = "block";
    }

    async function checkUserSession() {
      const token = localStorage.getItem("token");
      if (!token) return;

      try {
        const response = await fetch(`${apiBase}?action=getUser&token=${token}`);
        const data = await response.json();

        if (data.name) {
          updateUserInfo(data.name);
        } else {
          localStorage.removeItem("token");
          document.getElementById("login-button").style.display = "block";
          document.getElementById("register-button").style.display = "block";
          document.getElementById("logout-button").style.display = "none";
          document.querySelector(".header h1").textContent = "Tr√† S·ªØa Ngon";
        }
      } catch (error) {
        console.error("L·ªói ki·ªÉm tra phi√™n:", error);
        localStorage.removeItem("token");
        document.getElementById("login-button").style.display = "block";
        document.getElementById("register-button").style.display = "block";
        document.getElementById("logout-button").style.display = "none";
        document.querySelector(".header h1").textContent = "Tr√† S·ªØa Ngon";
      }
    }

    function logout() {
      localStorage.removeItem("token");
      document.getElementById("login-button").style.display = "block";
      document.getElementById("register-button").style.display = "block";
      document.getElementById("logout-button").style.display = "none";
      document.querySelector(".header h1").textContent = "Tr√† S·ªØa Ngon";
    }

    window.addEventListener("load", () => {
      checkUserSession();
    });
  </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'933e1f1f1e626fa1',t:'MTc0NTI1MTUxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
